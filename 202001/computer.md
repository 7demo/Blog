# 计算机网络概述

### 概述

三个网络包括：电话网络、有线电视网络、计算机网络。

计算机网络组成由节点与链路组成。节点包括计算机、集线器、交换机、路由器。

发展三个阶段：单个网络，三级结构互联网（主干网、地区网、校园网/企业网）、多层次ISP结构互联网（ISP互联网服务提供商——Internet Service Provider）。IPS分为主干ISP/的确ISP/本地ISP

电路交换：建立连接-通话-释放连接。效率低。

分组交换：存储转发技术。优点是灵活、高效、可靠、迅速。缺点：延时（要等待分组转发）、额外开销（分组所带信息）

报文交换：相邻节点存储所有信息再转发。

路由器：转发分组交换的。查找分组或者包中首部中的地址信息，转发到下一个路由器。

局域网：覆盖范围小，自己维护、带宽固定（10m、100m、1000m）；广域网：距离远，专业服务、花钱租带宽；城域网；个人区域网

单位：

    数据大小：数据大小为1M，则其基础单位为字节B，每个字节有8比特。就是2^10B为1KB，2^20为1MB。

    带宽：1Mbit/s 表示10^6个比特没秒

时延：

    传播时延：电磁波在信道中传播的时间。传播距离越远，时延越大。

    发送时延：也叫传输时延，是第一个字节起，到最后一个字节发送完所需时间。只发生在机器内部。

    处理时延：路由器收到分组进行处理的时间。

    排队时延：排队分组。

    时延带宽积：传播时延*带宽，这个是用来表示链路的长度。

    往返时延：RTT.

网络利用率：

    D（当前网络时延） = P（网络空闲时延） / 1 - U(网络利用率)



交换机：接入层交换机-汇聚层交换机，电脑到交换机不超过100m，交换机到另外交换机不超过100m。

不同运营商：双机房、双线机房

internet: ISP自己机房、对网民提供网络连接

网关（一般是路由器）：负责转发数据，局域网其他机器的数据转到此并转出。掩码几个255表示ip中有前几个为网络。

网络请求发送时数据时，每个数据包包含: 数据、源ip、目标ip、源mac地址、目标mac地址。数据、源ip、目标ip称为数据包，如果再加上mac地址，就称为数据帧。在传递过程中，经过网关，会更改mac地址。

发送数据时，先放缓存，再发，发送成功后才可以删除，否则可能重发。接收数据时，也有缓存，

标准：

    OSI

    TCP/IP：网络接口层、网际层IP、运输层（TCP/IP）、应用层

    5层协议

数据封装过程：

    应用层数据分段，在传输层加上TCP/UDP头部称为数据，在网络层加上IP头成为数据包，在数据链路层加上MAC地址称为数据帧。

### OSI模型

应用层：能产生流量的程序。

表示层：在传输中是否进行加密或者压缩

会话层：来确保传输的数据时针对的请求。ESTABLISTEN表示创建会话。

传输层：可靠传输、流量控制。（查询dns时，是udp通讯，是不可靠传输）

网络层：负责选择最佳路径、规划ip地址——》配置错误ip地址、子网掩码、错误网关

数据链层：帧的开始与结束、透明传输、差错校验——》mac地址冲突、ADSL、网络速度协定

物理层：定义网络设备标准、电器标准——》查看连接状态、发送接收数据包

![avatar](./images/computer/1.jpg)

![avatar](./images/computer/2.jpg)

### 性能

速率：信道中速度。

带宽：最高支持。

吞吐量：总共大小。

时延：发送时延（数据块大小/信道带宽）、传播时延、处理时延、排队时延。

时延带宽积：传播时延*带宽。

往返时间

利用率——网络利用率（信道利用率加权平均值）、信道利用率（有数据时间/总时间）

Bite: 位

1字节等于8位，8B。常说的带宽大小单位是位。


### 物理层

确定传输媒体的特性：机械特性、电气特性、功能特性、过程特性。

通信系统：源系统、传输系统、目的系统。

信号根据代表消息参数不一致，可以分为数字信号（离散信号）与模拟信号（连续信号）。

![avatar](./images/computer/3.png)

通信为了传输数据。数据——运送消息的实体。信号是数据的电气或者电磁的表现（模拟信号：取值是连续的，数字信号：取值是跳跃的）。码元：基本波形。1码元可以携带nbit信息量。

信道：单向通信、双向交替通信（半双工通信）、双向同时通信（全双工通信）。

基带信号：来源信源的信号，距离近时计算机都采用几袋信号（显示器、打印机）。是把数字信号转为另外一种数字信号，也称为编码。

带通信号：基带信号经过调制（调幅、调频、调相），长距离使用。把低波段搬移到高波段，并转为模拟信号，这个过程也是带通调制（手段：调幅、调频、调相）。

常用编码：比特流、归零制(正冲代表1，负冲代表0)、不归零制（正向代表1，负向代表0）、（单极性不归零码、双极性不归零码、单极性归零码、双极性归零码）、曼彻斯特编码（周期中心，向上代表0，向下代表1，能携带时钟信号，区分是否传输信号）、差分曼彻斯特编码（周期边界，有跳代表0，无跳代表1）。

奈氏原则：理想情况下，码元的传输速率有上限。

香浓公示：

信噪比：香农理论表示信道比（功率与干扰信号的比值）越大，传输的速率可以越大。

导向传出媒体：双绞线（屏蔽双绞线、无屏蔽双绞线）、同轴电缆（50欧姆同轴电缆——用于基带传输，也叫基带同轴电缆，75欧姆同轴电缆——用于模拟传输，也叫宽带同轴电缆）、光缆

网线：直通线顺序用于主机路由器到交互机集换器——白橙、橙、白绿、蓝、白蓝、绿、白棕、棕。交叉线用于主机到主机类的连接。

光纤：多模光纤与单模光纤（有线电视，带宽高

非导向传输媒体：无线传输。

集线器：放大增强网络信号，工作在物理层，已被交换机代替。交换机：交换两个网络信号，工作在链路层，会维护已接入设备的mac地址。集线器与交换机都是构建网络的。

路由器：网络路径规划。

信道复用：频分复用（带宽频率）、时分复用、统计时分复用、波分复用（波长）、码分复用

脉码调制有T1(24路时分复用)与E1（32路信道时分复用）标准。

宽带接入：ADSL——利用电话线（采用DMT频分技术，把40khz-1.1mhz中的25个子信道为上传，249个子信道为下载。40khz以下是电话用）、HFC——有线电视线。FTTx是光纤入户。

### 数据链层

数据链信道：点对点信道、广播信道。

数据链层传输的是帧，是把数据加上数据头、校验值与数据尾。

数据链路层：

1，封装成帧：就是加上帧头SOH、帧尾EOT

2，透明传输：如果帧中有类似帧尾的数据，为插入字符ESC来区分。解析时去掉插入的字符。

3，差错检测：（循环冗余检测CRC），错误类型：帧丢失、帧重复、帧失序

PPP协议，是属于点到点通信，用于广域网。除了以上特性，比较简单、还支持多网络协议、多类型链路，不具纠错、流量控制功能。信息部分最长不超过1500字节。PPP包括LCP（链路控制协议，可以实名验证）与NCPO(网络协议控制)。无链路-物理链路，进入链路创立状态-LCP配置协-网络链路-链路打开-链路终止-链路静止。

    用于同步或者异步串行介质

    建立链路连接

    多种网络协议

局域网现在都是集线结构，还有总线（不安全）、环形、星型等。

CSMA/CD用于碰撞监测、争用期。碰撞监测使传输效率低于以太网效率，因为边发边听，处于半双工状态。

CSMA协议用于广播通信。

以太网：只要满足载波监听冲突访问即是。使用集线器来组件，是星型结构。到集线器的距离不超100m。对于10Mb/s，最短帧为64字节。帧的间隔最小为9.6微秒，信号在1KM传播大概需要5微秒。

MAC地址，前24位是厂家，需要购买。

MAC帧：目标MAC地址（6字节）、源MAC地址（6字节）、类型（2字节，用来标识上一层用的协议）、数据（46-1500字节）、FCS（结束4字节）。以太网mac地址在类型前增加一个4字节的VLAN，用来标识属于哪个VLAN。

扩展以太网：集线器可以增加计算机数量，但是冲突域会扩大。通过网桥来解决（隔离冲突域），网桥变成交换机（直接接计算机），交换机独享带宽、学习mac地址、安全。

高速以太网，大于100m

### 网络层

设备：物理层的中间设备——转发器，链路层中间设备——交换机，网络层的中间设备——路由器，网络层以上的中间设备——网关。

网络层是在尽力转发数据包，不保证数据完整、顺序（传输层），数据包是分开转发的，可以负载。

子网掩码255的个数就是告诉计算机网络部分是多少，主机部分。比如子网掩码为255.255.0.0，那么192.168.1.1的192.168就是网部分，剩下的就是主机部分。划分子网后，IP就是：网络部分：主机部分

通过子网掩码来判断自己处于网段、对方处于网段，如果同一网站，则使用arp协议广播解析对方mac地址。如果不是同一网段，则发给路由器，

交换机是二层设备是指在链路层通过比特流读取mac地址。路由器是三层设备是获取数据包的ip地址，包括源地址与目标地址。再重新封装数据帧。

![avatar](./images/computer/4.jpg)


ARP（地址解析协议）协议是通信前的工作，位于ip协议工作前，只能解析本网段。ARP发送是广播，但是响应却是单播。

IP数据报常常是32位（4字节）表示，其中固定部分共20字节：

    4位的版本号，4位的首部长度，8位的区分服务，16位的总长度

    16位的标识（计数器）,3为的标志（是否还有分片），13位的片偏移

    8位的生存时间，8位的协议（上层协议，tcp是6，udp是17，igmp是1），16位的首部校验和

    源地址

    目标地址

    （可变部分24位），（填充8位）

    数据部分

ICMP（网际控制报文协议）/IGMP（网际组管理协议）协议用于检测网络故障，比如ping命令是ICMP。TTL的值为生存周期，表示可以经过多少个路由器节点。window系统是128，lunix是64，unix是255.

ICMP包括差错报告报文与询问报文。

IGMP是点播、多播、组播。

ping -i 2 更改数据包的途径路由器; -l 更改数据包大小；-t 一直ping

点到点通信、广播通信、组播（多播）。多播比如是电视不同频道，点到点可以建立通信调整进度。

路由选择：是RIP协议：动态路由每30s会更新一次，根据跳数来定。OSPF选择路径标准是带宽。

无分类间域间路由选择CIDR，解决ip短缺——ip地址后加划线，写上网络部分所占的位数。

IPV6比IpV4:

    更大的地址空间与地址层次机构，灵活首部形式，改进选项，允许扩展协议，增加有效荷载

IPV6:

    4位版本，8位通信向量，20位的流动标号

    16位的有效荷载长度，8位的下一个首部，8位的跳数限制

    128位的源地址

    128位的目标地址

    数据

### 传输层

传输层两个协议：TCP（传输控制协议）与UDP（用户数据报协议）

TCP: 面向连接，建立会话、分段、可靠、流量控制.只能点对点，可以实现全双工通信。首部有20字节。TCP连接的两个端点是套接字。

UDP：一个数据包完成通讯，不分段、不可靠、不能流量控制、不建立会话，面向报文（一次交付完整的报文）。DNS解析、QQ文字聊天、屏幕广播、rip、多媒体流通信。支持一对N，首部小只有8字节。

UDP首部：

    12字节的伪首部(4字节的源ip地址，4字节的目标ip地址，1字节的0，1字节的17，2字节的udp长度)，2字节的源端口（不需要时全是0），2字节的目标端口，2字节的长度，2字节的校验和

TCP首部：

    16位的源端口号、16位的目的端口号

    32位的序号（0 到 2的32次方-1）

    32位的确认号（确认号为n，则代表n-1都已收到）

    4位的数据偏移（指出tcp报文数据的起始处距离tcp报文起始处距离，其实是首部长度——因为选项长度的存在，虽然是4位，但是单位是32位字，最大值为60字节）、6位的保留字节（全是0）、URG（等于1代表紧急指针有效）/ACK（只有等于1时确认字段才有效，ACK等于0则表示请求创建连接）/PSH（推送，等于1时要求对方立即响应。当是发送方时：立即创建报文发送，是响应方时则立即交付数据不要等缓存）/RST（复位，等于1时必须释放连接重新建立）/SYN（等于1，创建连接，至于是请求还是响应则看ACK是否等于0，0的话是请求，不是0的话是响应）/Fin（等于1则介绍）（共6字节）、16位的窗口（接收方窗口大小）

    16位的校验和（与UDP一样，计算校验和加伪首部）、16位的紧急指针

    24位的选项（最长40字节），8位的填充

    此外还有3字节的窗口扩大选项（其中一个是位移值，表示窗口可以增加的大小，这个值最大为14，即窗口可以增加2的14次方），10字节的时间戳（4个字节的时间戳，4个字节的回送时间戳，可以用来计算往返时间与防止序号绕回），选择确认SCAK（报告某段未被确认）。

TCP最大报文段长度是MSS, 默认是1460字节。

端口：用于协议进程与传输实体数据交互的地址，16位。

端口的取值范围为：0-65525.分为熟悉端口（0-1023）、登记端口（1024-49151）、客户端端口（49152-65525）、

![avatar](./images/computer/6.jpg)

每个ip连接有两个端点，端点是ip+端口，即是套接字。

![avatar](./images/computer/5.jpg)

dns即可使用tcp53端口，又可使用udp53端口。但是upd居多。

SMTP是发邮件，pop2是收邮件。

ip中使用协议号来标识tcp与udp，tcp的协议号是6，udp是17，igmp是1

TCP: 可靠传输、流量控制、拥塞控制

可靠传输原理是：停止等待协议(自动重传请求ARQ)。

    发送正常

    出现差错

        发送完保留数据副本

        启动定时器，时间比平均传输往返时间长些（计算时不包括本次未响应的往返时间）

        发送与确认数据都进行编号

    确认丢失

        发送方重发后，收到方收到则丢弃，再发送确认。

    重复确认/确认迟到

        发送方丢弃重复的确认

停止等待协议缺点：信道利用率低，因此采用流水线传输——连续ARQ协议与滑动窗口协议

连续ARQ，发送窗口发送完确认放一般是累积确认。但是不能准确反映接收方已收到的信息。

捎带重传不经常发生。

流量控制是靠滑动窗口协议。持续计时器机制，是一方窗口收到对方窗口为0时，就会在计时器到期发送1字节的探测报文。如果仍未0，则继续启动一个持续计时器。

TCP触发: 数据达到最大报文长度MSS时；收到PSH字段；发送计时器到期。为了效率可以使用稍微确认。现在广泛使用Nagle算法——数据进入发送方TCP缓存，发送方先发送第一个数据字节，缓存后续到达数据，收到确认时，立即发送缓存。另外当然数据达到MSS或者窗口一半大小时，立即发送。针对糊涂窗口综合征，延迟发送确认，等待一段时间或者接收缓存有一半空闲时间。

TCP拥塞控制方法：慢启动（设置拥塞窗口rwnd，初始值为1或者1个MSS，之后每收到确认就值翻倍1-2-4-8（直至达到慢开始门限），实际上没收到一个确认就会加1）、拥塞避免（每经过1个RRT，则拥塞窗口就加1，当出现超时时则调整门限值重新慢开始）、快重传（针对网络好时出现的确认丢失，即要求接收方不要等待捎带确认，而要立即确认，发送放收到多次同一序号的确认则立即发送）、快恢复（发送方发现只是丢失部分数据，收到三次同样的确认信号，则执行快恢复，调整门限值，紧着执行拥塞避免）。

路由器处理时先进先出，如果队列慢，则执行尾部丢失策略。为了避免大批同时丢失，有主动队列管理，当队列值达到一定值时就主动丢弃（随机RED），提醒发送方注意。

三次握手：

    1，客户端关闭状态，服务端是等待连接状态。客户端发送SYN=1，seq=x,进入syn-sent状态

    2，服务端响应：SYN=1, ACK=1, seq=y,ack=x+1，进入syn-recvd状态

    3，客户端进入established状态，发送ACK=1, seq=x+1, ack=y+1.服务端进入established状态

四次挥手：

    1，客户端与服务端都是tablished状态，客户端发FIN=1, seq=u进入FIN-wait1状态

    2，服务端响应ACK=1，seq=v, ack=u+1，进入close-wait，客户端收到进入FIN-wait2状态

    3，服务端发送FIN=1, ACK=1, seq=w, ack=u+1，进入last-ack

    4, 客户端响应ACK=1, seq=u+1, ack=w+1，客户端进入time-wait阶段（等待2MSL——最长报文段寿命，是2分钟，然后关闭）,服务端收到close状态


针对突然断开的情况：

    保活计时器，时间通常为2个小时，2个小时没收到数据，则主动服务器发送一个探测报文，以后每隔75s发送，若10次都没有，则认为客户端故障，则关闭连接。



![avatar](./images/computer/7.jpg)

![avatar](./images/computer/8.jpg)

流水线传输，不等确认回，就一直发。

![avatar](./images/computer/9.jpg)

位置发送窗口，类似缓存区，大小固定，收到确认，移动窗口。

累计确认，更高效。但是如果丢失包后有收到包则不能正确反馈。

![avatar](./images/computer/10.jpg)

tcp每发一次报文，都有一个计时器，计时器结束未有收到确认，就重新传，重传时间略大于加权平均往返时间。

tcp流量控制是通过调整窗口大小来确定的。

### 应用层

域名：

根域名是“.”， 顶级域名com/cn/...，二级域名baidu/jd

nslookup来确认dns解析服务商

DHCP服务器动态分配ip。分配的ip具有一定期限，如过期未续约，则回收。可以跨网段分配（ip helper-address）。

FTP使用两个tcp链接，一个控制连接（21端口），一个传输连接——主动模式，服务端从20端口向客户端发起连接；被动模式在范围内的端口等待客户端发起连接。

### 网络安全

中断、截获、伪造、篡改

网络层安全-IPsec——SA（安全关联）

![avatar](./images/computer/11.jpg)

数据链路层安全——身份证验证（ADSL拨号）、PPP协议身份验证、防火墙

### 无线局域网

![avatar](./images/computer/12.jpg)

视频分为：流式音视频（边下载边播放）、流式实况视频（边录边播比发送）、交互式音视频
